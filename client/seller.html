import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

let db;
const sList = document.getElementById('seller-product-list');

// 1. Vercel سے کیز لے کر ایپ شروع کریں
async function initSellerApp() {
    try {
        const response = await fetch('/api/get-firebase-config');
        const firebaseConfig = await response.json();

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        
        console.log("Seller Panel Connected! ⚡");
        loadMyProducts(); // موجودہ پروڈکٹس لوڈ کریں
        
    } catch (error) {
        alert("کنکشن میں خرابی: " + error.message);
    }
}

// 2. نئی پروڈکٹ اپلوڈ کرنے کا فنکشن
document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerText = "اپلوڈ ہو رہا ہے...";

    try {
        await addDoc(collection(db, "products"), {
            name: document.getElementById('p-name').value,
            price: document.getElementById('p-price').value,
            image: document.getElementById('p-img').value || "/public/logo.png",
            time: Date.now()
        });
        alert("پروڈکٹ مارکیٹ میں لائیو ہوگئی! ✅");
        document.getElementById('upload-form').reset();
        loadMyProducts(); // لسٹ اپڈیٹ کریں
    } catch (err) {
        alert("اپلوڈ میں مسئلہ: " + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "مارکیٹ میں لائیو کریں ⚡";
    }
});

// 3. سیلر کی اپنی پروڈکٹس دکھانے کا فنکشن
async function loadMyProducts() {
    sList.innerHTML = "<p style='color:#00ff00'>لوڈنگ...</p>";
    const querySnapshot = await getDocs(collection(db, "products"));
    sList.innerHTML = "";

    querySnapshot.forEach((documentObj) => {
        const p = documentObj.data();
        const id = documentObj.id;
        
        const div = document.createElement('div');
        div.className = 's-card'; // یہ کلاس ہم نے پہلے CSS میں دی تھی
        div.innerHTML = `
            <img src="${p.image || '/public/logo.png'}" style="width:50px; border-radius:5px;">
            <div style="flex-grow:1; margin-right:15px;">
                <strong>${p.name}</strong><br>
                <span style="color: #00ff00;">Rs. ${p.price}</span>
            </div>
            <button class="delete-btn" onclick="deleteItem('${id}')" style="background:#ff4444; border:none; color:white; padding:5px; border-radius:4px;">مٹائیں</button>
        `;
        sList.appendChild(div);
    });
}

// ڈیلیٹ کرنے کا فنکشن
window.deleteItem = async (docId) => {
    if(confirm("کیا آپ اسے ختم کرنا چاہتے ہیں؟")) {
        await deleteDoc(doc(db, "products", docId));
        loadMyProducts();
    }
};

initSellerApp();
